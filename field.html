<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="field_title">TASMAN LOGIC // CONFIG</title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
</head>

<body class="bg-slate-950 text-slate-200 font-sans selection:bg-cyan-500/30 overflow-y-auto">
    <div
        class="fixed inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black pointer-events-none">
    </div>

    <main class="relative z-10 p-8 max-w-4xl mx-auto min-h-screen flex flex-col">
        <header class="flex justify-between items-center border-b border-white/5 pb-6 mb-12">
            <div>
                <h1 class="text-2xl font-black text-cyan-500 tracking-tighter uppercase" data-i18n="field">FIELD TWIN //
                    FIELD</h1>
                <p class="text-[10px] text-slate-500 font-technical uppercase" data-i18n="static_load_subtitle">//
                    STATIC LOAD & BEHAVIORAL INERTIA</p>
            </div>
            <div class="flex gap-4 items-center">
                <a href="./index.html"
                    class="px-4 py-2 border border-white/10 rounded text-[10px] hover:bg-slate-800 transition-colors uppercase font-bold tracking-widest text-slate-400"
                    data-i18n="back_to_hud">Back
                    to HUD</a>
                <button id="save-btn"
                    class="px-8 py-2 bg-cyan-600/20 border border-cyan-500/50 rounded text-[10px] hover:bg-cyan-500 hover:text-white transition-all uppercase font-black tracking-[0.2em] text-cyan-500 shadow-[0_0_15px_rgba(34,211,238,0.1)]"
                    data-i18n="save_btn">SAVE CHANGES</button>
            </div>
        </header>

        <div class="flex-1 max-w-2xl mx-auto w-full glass-panel rounded-xl p-8 space-y-12">
            <section class="space-y-6">
                <div class="flex justify-between items-center">
                    <div class="space-y-1">
                        <h2 class="text-xs font-bold text-cyan-500 uppercase tracking-[0.2em]" data-i18n="static_load">
                            INSTANTANEOUS LOAD</h2>
                        <p class="text-[10px] text-slate-600 uppercase italic font-technical" data-i18n="agg_demand">//
                            AGGREGATE REAL-TIME
                            DEMAND</p>
                    </div>
                    <span id="base-load-val" class="text-4xl font-technical text-cyan-400">0.78 <small
                            class="text-sm">kW</small></span>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between text-[8px] uppercase text-slate-500 font-bold tracking-widest">
                        <span data-i18n="bg_flux">Background Flux</span>
                        <span id="slider-readout" class="font-technical text-cyan-600">0.50 kW</span>
                    </div>
                    <input type="range" id="load-slider" min="0" max="2.0" step="0.05" value="0.50"
                        class="w-full h-1 bg-white/5 rounded-lg appearance-none cursor-pointer accent-cyan-500 border border-white/5">
                </div>

                <div
                    class="grid grid-cols-3 gap-4 text-[7px] font-black uppercase tracking-[0.3em] text-slate-700 pt-2">
                    <div class="text-left" data-i18n="min_label">Min</div>
                    <div class="text-center" data-i18n="nominal_label">Nominal</div>
                    <div class="text-right" data-i18n="high_flux_label">High Flux</div>
                </div>
            </section>

            <!-- New Household Appliances Section -->
            <section class="space-y-6 border-t border-white/5 pt-8">
                <div class="space-y-1">
                    <h2 class="text-xs font-bold text-emerald-500 uppercase tracking-[0.2em]"
                        data-i18n="household_appliances">
                        HOUSEHOLD APPLIANCES</h2>
                    <p class="text-[10px] text-slate-600 uppercase italic font-technical" data-i18n="individual_assets">
                        // INDIVIDUAL ASSETS LOAD</p>
                </div>

                <div class="space-y-8">
                    <!-- Baseline Assets (Always On) -->
                    <div class="space-y-4">
                        <h3 class="text-[9px] font-black text-emerald-500/60 uppercase tracking-widest border-l-2 border-emerald-500/30 pl-2"
                            data-i18n="baseline_assets">
                            BASELINE ASSETS (24/7)</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <!-- Dynamic Background Flux (Infra) -->
                            <label
                                class="p-3 border border-emerald-500/30 rounded glass-card flex justify-between items-center cursor-default bg-emerald-500/5 group relative overflow-hidden">
                                <div class="absolute inset-0 bg-emerald-500/5 animate-pulse"></div>
                                <div class="flex items-center gap-3 relative z-10">
                                    <div
                                        class="w-1.5 h-1.5 rounded-full bg-emerald-400 shadow-[0_0_15px_rgba(52,211,153,0.5)]">
                                    </div>
                                    <div class="flex flex-col text-left">
                                        <span class="text-[10px] font-bold uppercase text-emerald-400"
                                            data-i18n="phantom_flux">Infrastructure Flux</span>
                                        <span class="text-[7px] text-emerald-700/60 uppercase font-black tracking-tight"
                                            data-i18n="phantom_flux_desc">System Standby & Network</span>
                                    </div>
                                </div>
                                <span id="phantom-flux-val"
                                    class="text-[10px] font-technical text-emerald-400 relative z-10 font-bold">0.00
                                    kW</span>
                            </label>

                            <label
                                class="p-3 border border-white/5 rounded glass-card flex justify-between items-center cursor-pointer hover:border-emerald-500 transition-colors group">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="appliance-toggle hidden" data-power="0.15" checked>
                                    <div
                                        class="toggle-dot w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]">
                                    </div>
                                    <span class="text-[10px] font-bold uppercase" data-i18n="fridge">Refrigerator</span>
                                </div>
                                <span class="text-[10px] font-technical text-slate-400">0.15 kW</span>
                            </label>
                            <label
                                class="p-3 border border-white/5 rounded glass-card flex justify-between items-center cursor-pointer hover:border-emerald-500 transition-colors group">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="appliance-toggle hidden" data-power="0.02" checked>
                                    <div
                                        class="toggle-dot w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]">
                                    </div>
                                    <span class="text-[10px] font-bold uppercase" data-i18n="router">Wireless
                                        Router</span>
                                </div>
                                <span class="text-[10px] font-technical text-slate-400">0.02 kW</span>
                            </label>
                            <label
                                class="p-3 border border-white/5 rounded glass-card flex justify-between items-center cursor-pointer hover:border-emerald-500 transition-colors group">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="appliance-toggle hidden" data-power="0.04" checked>
                                    <div
                                        class="toggle-dot w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]">
                                    </div>
                                    <span class="text-[10px] font-bold uppercase" data-i18n="security_cam">Security
                                        System</span>
                                </div>
                                <span class="text-[10px] font-technical text-slate-400">0.04 kW</span>
                            </label>
                            <label
                                class="p-3 border border-white/5 rounded glass-card flex justify-between items-center cursor-pointer hover:border-emerald-500 transition-colors group">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="appliance-toggle hidden" data-power="0.06" checked>
                                    <div
                                        class="toggle-dot w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]">
                                    </div>
                                    <span class="text-[10px] font-bold uppercase" data-i18n="nas_server">NAS Storage
                                        Server</span>
                                </div>
                                <span class="text-[10px] font-technical text-slate-400">0.06 kW</span>
                            </label>
                            <label
                                class="p-3 border border-white/5 rounded glass-card flex justify-between items-center cursor-pointer hover:border-emerald-500 transition-colors group">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="appliance-toggle hidden" data-power="0.01" checked>
                                    <div
                                        class="toggle-dot w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]">
                                    </div>
                                    <span class="text-[10px] font-bold uppercase" data-i18n="smart_hub">Smart Hub</span>
                                </div>
                                <span class="text-[10px] font-technical text-slate-400">0.01 kW</span>
                            </label>
                        </div>
                    </div>

                    <!-- Active Assets (Toggleable) -->
                    <div class="space-y-4">
                        <h3 class="text-[9px] font-black text-amber-500/60 uppercase tracking-widest border-l-2 border-amber-500/30 pl-2"
                            data-i18n="active_assets">
                            ACTIVE USAGE ASSETS</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <label
                                class="p-3 border border-white/5 rounded glass-panel flex justify-between items-center cursor-pointer hover:border-amber-500/50 transition-colors group">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="appliance-toggle hidden" data-power="0.12">
                                    <div
                                        class="toggle-dot w-1.5 h-1.5 rounded-full bg-slate-700 transition-all shadow-none">
                                    </div>
                                    <span class="text-[10px] font-bold uppercase" data-i18n="tv">Television</span>
                                </div>
                                <span class="text-[10px] font-technical text-slate-400">0.12 kW</span>
                            </label>
                            <label
                                class="p-3 border border-white/5 rounded glass-panel flex justify-between items-center cursor-pointer hover:border-amber-500/50 transition-colors group">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="appliance-toggle hidden" data-power="1.20">
                                    <div
                                        class="toggle-dot w-1.5 h-1.5 rounded-full bg-slate-700 transition-all shadow-none">
                                    </div>
                                    <span class="text-[10px] font-bold uppercase" data-i18n="washing_machine">Washing
                                        Machine</span>
                                </div>
                                <span class="text-[10px] font-technical text-slate-400">1.20 kW</span>
                            </label>
                            <label
                                class="p-3 border border-white/5 rounded glass-panel flex justify-between items-center cursor-pointer hover:border-amber-500/50 transition-colors group">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="appliance-toggle hidden" data-power="1.80">
                                    <div
                                        class="toggle-dot w-1.5 h-1.5 rounded-full bg-slate-700 transition-all shadow-none">
                                    </div>
                                    <span class="text-[10px] font-bold uppercase"
                                        data-i18n="dishwasher">Dishwasher</span>
                                </div>
                                <span class="text-[10px] font-technical text-slate-400">1.80 kW</span>
                            </label>
                            <label
                                class="p-3 border border-white/5 rounded glass-panel flex justify-between items-center cursor-pointer hover:border-amber-500/50 transition-colors group">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="appliance-toggle hidden" data-power="1.10">
                                    <div
                                        class="toggle-dot w-1.5 h-1.5 rounded-full bg-slate-700 transition-all shadow-none">
                                    </div>
                                    <span class="text-[10px] font-bold uppercase" data-i18n="microwave">Microwave</span>
                                </div>
                                <span class="text-[10px] font-technical text-slate-400">1.10 kW</span>
                            </label>
                            <label
                                class="p-3 border border-white/5 rounded glass-panel flex justify-between items-center cursor-pointer hover:border-amber-500/50 transition-colors group">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="appliance-toggle hidden" data-power="2.20">
                                    <div
                                        class="toggle-dot w-1.5 h-1.5 rounded-full bg-slate-700 transition-all shadow-none">
                                    </div>
                                    <span class="text-[10px] font-bold uppercase" data-i18n="kettle">Electric
                                        Kettle</span>
                                </div>
                                <span class="text-[10px] font-technical text-slate-400">2.20 kW</span>
                            </label>
                            <label
                                class="p-3 border border-white/5 rounded glass-panel flex justify-between items-center cursor-pointer hover:border-amber-500/50 transition-colors group">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="appliance-toggle hidden" data-power="1.50">
                                    <div
                                        class="toggle-dot w-1.5 h-1.5 rounded-full bg-slate-700 transition-all shadow-none">
                                    </div>
                                    <span class="text-[10px] font-bold uppercase" data-i18n="hair_dryer">Hair
                                        Dryer</span>
                                </div>
                                <span class="text-[10px] font-technical text-slate-400">1.50 kW</span>
                            </label>
                        </div>
                    </div>
                </div>
                <p class="text-[8px] text-slate-500 italic uppercase" data-i18n="baseline_info">* Baseline assets
                    formulate the static noise
                    floor. Active assets quantify instantaneous demand surcharges.</p>
            </section>

            <section class="space-y-6">
                <div class="flex justify-between items-end">
                    <div class="space-y-1">
                        <h2 class="text-xs font-bold text-purple-500 uppercase tracking-[0.2em]"
                            data-i18n="habit_profile">
                            BEHAVIORAL RHYTHM LEARNING</h2>
                        <p class="text-[10px] text-slate-600 uppercase italic font-technical">// REAL-TIME HOBART SYNC
                        </p>
                    </div>
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <span
                            class="text-[9px] font-black text-slate-500 group-hover:text-purple-400 transition-colors">AUTOPILOT</span>
                        <div id="autopilot-toggle"
                            class="w-10 h-5 bg-white/5 rounded-full relative border border-white/10 transition-colors">
                            <div class="dot absolute left-1 top-1 w-3 h-3 bg-slate-600 rounded-full transition-all">
                            </div>
                        </div>
                    </label>
                </div>

                <div id="habit-container" class="grid grid-cols-1 gap-2 transition-opacity">
                    <button
                        class="habit-btn p-5 border border-white/5 rounded glass-card hover:border-purple-500 transition-all flex justify-between items-center group text-left"
                        data-val="ECO_CONSCIOUS">
                        <div>
                            <span class="text-[10px] font-bold uppercase tracking-widest block"
                                data-i18n="habit_eco_title">LEARNED ECO
                                RHYTHM</span>
                            <span class="text-[8px] text-slate-500 font-technical italic" data-i18n="eco_desc">// Rhythm
                                aligned with solar/biological peaks</span>
                            <div class="flex gap-2 mt-2 opacity-30 group-hover:opacity-100 transition-opacity">
                                <span class="px-1.5 py-0.5 border border-white/10 rounded-sm text-[7px] uppercase">Wake:
                                    07:00</span>
                                <span class="px-1.5 py-0.5 border border-white/10 rounded-sm text-[7px] uppercase">DHW:
                                    22:30</span>
                            </div>
                        </div>
                        <span
                            class="w-2 h-2 rounded-full border border-purple-500/30 group-hover:bg-purple-500 transition-colors"></span>
                    </button>

                    <button
                        class="habit-btn p-5 border border-white/10 rounded glass-panel hover:border-purple-500 transition-all flex justify-between items-center group text-left"
                        data-val="HOME_OFFICE">
                        <div>
                            <span class="text-[10px] font-bold text-purple-400 uppercase tracking-widest block"
                                data-i18n="habit_office_title">DYNAMIC
                                OFFICE FLUX</span>
                            <span class="text-[8px] text-purple-900/50 font-technical italic text-purple-700"
                                data-i18n="office_desc">// High-intensity day flux & stability focus</span>
                            <div class="flex gap-2 mt-2 opacity-50 group-hover:opacity-100 transition-opacity">
                                <span
                                    class="px-1.5 py-0.5 border border-purple-500/20 rounded-sm text-[7px] uppercase">Coffee:
                                    08:30</span>
                                <span
                                    class="px-1.5 py-0.5 border border-purple-500/20 rounded-sm text-[7px] uppercase">Peak
                                    Work: 10:00-16:00</span>
                            </div>
                        </div>
                        <span class="w-2 h-2 rounded-full bg-purple-500 shadow-[0_0_8px_rgba(168,85,247,0.5)]"></span>
                    </button>

                    <button
                        class="habit-btn p-5 border border-white/5 rounded glass-card hover:border-purple-500 transition-all flex justify-between items-center group text-left"
                        data-val="ENTERTAINMENT">
                        <div>
                            <span class="text-[10px] font-bold uppercase tracking-widest block"
                                data-i18n="habit_ent_title">PEAK LIFESTYLE
                                DENSITY</span>
                            <span class="text-[8px] text-slate-500 font-technical italic" data-i18n="ent_desc">//
                                Evening behavior density & thermal pulse</span>
                            <div class="flex gap-2 mt-2 opacity-30 group-hover:opacity-100 transition-opacity">
                                <span class="px-1.5 py-0.5 border border-white/10 rounded-sm text-[7px] uppercase">Home:
                                    18:00</span>
                                <span
                                    class="px-1.5 py-0.5 border border-white/10 rounded-sm text-[7px] uppercase">Cooking/TV:
                                    19:30</span>
                                <span
                                    class="px-1.5 py-0.5 border border-white/10 rounded-sm text-[7px] uppercase">Dishw:
                                    21:00</span>
                            </div>
                        </div>
                        <span
                            class="w-2 h-2 rounded-full border border-purple-500/30 group-hover:bg-purple-500 transition-colors"></span>
                    </button>
                </div>
            </section>
        </div>

        <footer class="mt-auto pt-8 border-t border-white/5 text-[9px] text-slate-600 flex justify-between uppercase">
            <span id="status-text" class="font-technical tracking-widest" data-i18n="status_mapped">Inertia: Mapping
                real-time demand
                flux...</span>
            <span class="font-technical" data-i18n="field_v_status">FIELD TWIN V1.2 // POLISHED</span>
        </footer>
    </main>

    <script type="module">
        import { StateManager } from './state-manager.js';
        import { TRANSLATIONS } from './i18n.js';
        import { BehaviorPilot } from './behavior-pilot.js';

        const loadSlider = document.getElementById('load-slider');
        const loadVal = document.getElementById('base-load-val');
        const habitBtns = document.querySelectorAll('.habit-btn');
        const saveBtn = document.getElementById('save-btn');
        const statusText = document.getElementById('status-text');

        const lang = localStorage.getItem('tasman-lang') || 'en';
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (TRANSLATIONS[lang][key]) {
                if (el.tagName === 'TITLE') {
                    document.title = TRANSLATIONS[lang][key];
                } else {
                    el.textContent = TRANSLATIONS[lang][key];
                }
            }
        });

        const state = StateManager.get().field;
        let pendingState = { ...state };

        const applianceToggles = document.querySelectorAll('.appliance-toggle');
        const sliderReadout = document.getElementById('slider-readout');

        const calculateTotalLoad = () => {
            let total = parseFloat(loadSlider.value);
            applianceToggles.forEach(toggle => {
                if (toggle.checked) total += parseFloat(toggle.dataset.power);
            });
            return total;
        };

        const autoToggle = document.getElementById('autopilot-toggle');
        const autoDot = autoToggle.querySelector('.dot');
        const habitContainer = document.getElementById('habit-container');

        const updateUI = (s) => {
            const totalLoad = calculateTotalLoad();
            const bgFlux = parseFloat(loadSlider.value);

            loadVal.innerHTML = `${totalLoad.toFixed(2)} <small class="text-sm">kW</small>`;
            if (sliderReadout) sliderReadout.textContent = `${bgFlux.toFixed(2)} kW`;

            // Sync Phantom Flux Asset Label
            const phantomFluxEl = document.getElementById('phantom-flux-val');
            if (phantomFluxEl) phantomFluxEl.textContent = `${bgFlux.toFixed(2)} kW`;

            // Sync Autopilot UI
            if (s.autopilot) {
                autoToggle.classList.add('bg-purple-500/20', 'border-purple-500/50');
                autoDot.style.left = '24px';
                autoDot.classList.replace('bg-slate-600', 'bg-purple-400');
                habitContainer.classList.add('opacity-40', 'pointer-events-none');
            } else {
                autoToggle.classList.remove('bg-purple-500/20', 'border-purple-500/50');
                autoDot.style.left = '4px';
                autoDot.classList.replace('bg-purple-400', 'bg-slate-600');
                habitContainer.classList.remove('opacity-40', 'pointer-events-none');
            }

            habitBtns.forEach(btn => {
                const isActive = btn.dataset.val === s.habit;
                btn.classList.toggle('border-purple-500', isActive);
                btn.classList.toggle('glass-panel', isActive);
                const dot = btn.querySelector('.w-2');
                if (isActive) {
                    dot.className = 'w-2 h-2 rounded-full bg-purple-500 shadow-[0_0_8px_rgba(168,85,247,0.5)]';
                } else {
                    dot.className = 'w-2 h-2 rounded-full border border-purple-500/30';
                }
            });
        };

        const syncAutopilotState = () => {
            if (!pendingState.autopilot) return;

            const now = new Date();
            // Simulating Hobart hour (simplified for UI feedback)
            const hour = now.getHours();

            const APPLIANCES_LIST = [
                { key: 'fridge', power: 0.15, isBaseline: true },
                { key: 'router', power: 0.02, isBaseline: true },
                { key: 'security_cam', power: 0.04, isBaseline: true },
                { key: 'nas_server', power: 0.06, isBaseline: true },
                { key: 'smart_hub', power: 0.01, isBaseline: true },
                { key: 'tv', power: 0.12, isBaseline: false },
                { key: 'washing_machine', power: 1.20, isBaseline: false },
                { key: 'dishwasher', power: 1.80, isBaseline: false },
                { key: 'microwave', power: 1.10, isBaseline: false },
                { key: 'kettle', power: 2.20, isBaseline: false },
                { key: 'hair_dryer', power: 1.50, isBaseline: false }
            ];

            const behavior = BehaviorPilot.calculateAutopilotLoad(hour, APPLIANCES_LIST);
            loadSlider.value = behavior.background;

            applianceToggles.forEach(toggle => {
                const key = toggle.getAttribute('data-i18n');
                const isBaseline = toggle.closest('.space-y-4').querySelector('h3').dataset.i18n === 'baseline_assets';

                if (isBaseline) {
                    toggle.checked = true;
                } else {
                    toggle.checked = behavior.activeKeys.includes(key);
                }

                const dot = toggle.nextElementSibling;
                if (toggle.checked) {
                    dot.className = isBaseline
                        ? 'toggle-dot w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]'
                        : 'toggle-dot w-1.5 h-1.5 rounded-full bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.5)]';
                } else {
                    dot.className = 'toggle-dot w-1.5 h-1.5 rounded-full bg-slate-700 shadow-none';
                }
            });
            updateUI(pendingState);
        };

        updateUI(state);
        if (state.autopilot) syncAutopilotState();

        // Data Sync from main loop (especially for Hobart Time sync)
        StateManager.subscribe((fullState) => {
            if (pendingState.autopilot && !saveBtn.classList.contains('animate-pulse')) {
                // If autopilot is on and user hasn't started manual tuning, sync with master time
                const hour = new Date(Date.now()).getHours(); // Fallback for UI visualization
                syncAutopilotState();
            }
        });
        autoToggle.addEventListener('click', () => {
            pendingState.autopilot = !pendingState.autopilot;
            if (pendingState.autopilot) syncAutopilotState();
            updateUI(pendingState);
            markUnsaved();
        });

        applianceToggles.forEach(toggle => {
            toggle.addEventListener('change', () => {
                const isBaseline = toggle.closest('.space-y-4').querySelector('h3').dataset.i18n === 'baseline_assets';
                const dot = toggle.nextElementSibling;

                if (toggle.checked) {
                    dot.className = isBaseline
                        ? 'toggle-dot w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]'
                        : 'toggle-dot w-1.5 h-1.5 rounded-full bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.5)]';
                } else {
                    dot.className = 'toggle-dot w-1.5 h-1.5 rounded-full bg-slate-700 shadow-none';
                }

                updateUI(pendingState);
                markUnsaved();
            });
        });

        loadSlider.addEventListener('input', () => {
            updateUI(pendingState);
            markUnsaved();
        });

        const HABIT_PRESETS = {
            'ECO_CONSCIOUS': { background: 0.15, active: [] },
            'HOME_OFFICE': { background: 0.65, active: ['tv', 'nas_server', 'smart_hub'] },
            'ENTERTAINMENT': { background: 1.10, active: ['tv', 'kettle', 'microwave'] }
        };

        habitBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const habit = btn.dataset.val;
                pendingState.habit = habit;

                const preset = HABIT_PRESETS[habit];
                if (preset) {
                    loadSlider.value = preset.background;
                    applianceToggles.forEach(toggle => {
                        const key = toggle.getAttribute('data-i18n');
                        const isBaseline = toggle.closest('.space-y-4').querySelector('h3').dataset.i18n === 'baseline_assets';

                        if (isBaseline) {
                            toggle.checked = true; // Baseline is always on in presets
                        } else {
                            toggle.checked = preset.active.includes(key);
                        }

                        // Update dots visually
                        const dot = toggle.nextElementSibling;
                        if (toggle.checked) {
                            dot.className = isBaseline
                                ? 'toggle-dot w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]'
                                : 'toggle-dot w-1.5 h-1.5 rounded-full bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.5)]';
                        } else {
                            dot.className = 'toggle-dot w-1.5 h-1.5 rounded-full bg-slate-700 shadow-none';
                        }
                    });
                }

                updateUI(pendingState);
                markUnsaved();
            });
        });

        function markUnsaved() {
            saveBtn.classList.add('animate-pulse', 'border-cyan-400', 'shadow-[0_0_20px_rgba(34,211,238,0.3)]');
            statusText.textContent = TRANSLATIONS[lang].tuning_mode;
        }

        saveBtn.addEventListener('click', () => {
            StateManager.set('field', pendingState);
            saveBtn.classList.remove('animate-pulse', 'border-cyan-400', 'shadow-[0_0_20px_rgba(34,211,238,0.3)]');
            saveBtn.textContent = TRANSLATIONS[lang].changes_saved;
            statusText.textContent = TRANSLATIONS[lang].changes_saved;
            setTimeout(() => {
                saveBtn.textContent = TRANSLATIONS[lang].save_btn;
            }, 2000);
        });
    </script>
</body>

</html>