<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="space_title">TASMAN LOGIC // CONFIG</title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
</head>

<body class="bg-slate-950 text-slate-200 font-sans selection:bg-green-500/30 overflow-hidden">
    <div
        class="fixed inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black pointer-events-none">
    </div>

    <main class="relative z-10 p-8 max-w-4xl mx-auto h-screen flex flex-col">
        <header class="flex justify-between items-center border-b border-white/5 pb-6 mb-12">
            <div>
                <h1 class="text-2xl font-black text-green-500 tracking-tighter uppercase" data-i18n="space">TASMAN LOGIC
                    // SPACE</h1>
                <p class="text-[10px] text-slate-500 font-technical uppercase" data-i18n="thermal_arbitration">//
                    THERMAL ENVIRONMENT ARBITRATION</p>
            </div>
            <div class="flex gap-4 items-center">
                <a href="./index.html"
                    class="px-4 py-2 border border-white/10 rounded text-[10px] hover:bg-slate-800 transition-colors uppercase font-bold tracking-widest text-slate-400"
                    data-i18n="back_to_hud">Back
                    to HUD</a>
                <button id="save-btn"
                    class="px-8 py-2 bg-green-600/20 border border-green-500/50 rounded text-[10px] hover:bg-green-500 hover:text-white transition-all uppercase font-black tracking-[0.2em] text-green-500 shadow-[0_0_15px_rgba(34,197,94,0.1)]"
                    data-i18n="save_btn">SAVE CHANGES</button>
            </div>
        </header>

        <div id="ai-console-container">
            <!-- AI Neural Console (Injected via JS for consistency or hardcoded here) -->
            <div
                class="mb-8 p-4 bg-purple-500/5 border border-purple-500/20 rounded-lg glass-card relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-1 h-full bg-purple-500 shadow-[0_0_15px_rgba(168,85,247,0.5)]">
                </div>
                <div class="flex justify-between items-center mb-2">
                    <h3
                        class="text-[9px] font-black text-purple-400 uppercase tracking-[0.3em] flex items-center gap-2">
                        <span class="relative flex h-1.5 w-1.5">
                            <span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-purple-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-purple-500"></span>
                        </span>
                        AURA NEURAL CONSOLE
                    </h3>
                    <span class="text-[7px] text-purple-900/40 font-mono tracking-tighter"
                        data-i18n="cognitive_sync_active">COGNITIVE SYNC: ACTIVE</span>
                </div>
                <p id="ai-insight-text" class="text-[10px] leading-relaxed text-slate-300 italic font-medium mb-4"
                    data-i18n="neural_initializing">
                    Neural link initializing... Awaiting thermal telemetry.
                </p>

                <div class="relative mt-4 group/input">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="text-[8px] text-purple-600 font-black">CMD></span>
                    </div>
                    <input type="text" id="ai-command-input"
                        class="block w-full pl-10 pr-3 py-2 bg-purple-950/20 border border-purple-500/20 rounded-md text-[10px] text-purple-200 placeholder-purple-900/50 focus:outline-none focus:border-purple-500/50 transition-all font-mono outline-none"
                        placeholder="..." data-i18n-placeholder="cmd_placeholder">
                    <div id="ai-status-pulse"
                        class="absolute inset-y-0 right-0 pr-3 flex items-center opacity-0 transition-opacity">
                        <span class="text-[6px] text-purple-500 animate-pulse uppercase select-none"
                            data-i18n="processing">Processing...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 max-w-4xl mx-auto w-full grid grid-cols-1 md:grid-cols-2 gap-8 overflow-y-auto">
            <!-- Left: Controls -->
            <div class="glass-panel rounded-xl p-6 space-y-10">
                <section class="space-y-6">
                    <div class="flex justify-between items-center">
                        <div class="space-y-1 text-left">
                            <h2 class="text-xs font-bold text-green-500 uppercase tracking-[0.2em]"
                                data-i18n="outdoor_temp">OUTDOOR TEMP</h2>
                            <p class="text-[10px] text-slate-600 uppercase italic font-technical"
                                data-i18n="ambient_sensing">// AMBIENT SENSING</p>
                        </div>
                        <span id="outdoor-val" class="text-4xl font-technical text-green-400">14.5<small
                                class="text-sm">째C</small></span>
                    </div>
                    <input type="range" id="outdoor-slider" min="-10" max="40" step="0.5" value="14.5"
                        class="w-full h-1 bg-white/5 rounded-lg appearance-none cursor-pointer accent-green-500 border border-white/5">
                </section>

                <section class="space-y-6">
                    <div class="flex justify-between items-center">
                        <div class="space-y-1 text-left">
                            <h2 class="text-xs font-bold text-cyan-500 uppercase tracking-[0.2em]"
                                data-i18n="indoor_temp">INDOOR TARGET</h2>
                            <p class="text-[10px] text-slate-600 uppercase italic font-technical"
                                data-i18n="comfort_arbitration">// COMFORT ARBITRATION
                            </p>
                        </div>
                        <span id="indoor-val" class="text-4xl font-technical text-cyan-400">22.0<small
                                class="text-sm">째C</small></span>
                    </div>
                    <input type="range" id="indoor-slider" min="16" max="30" step="0.5" value="22.0"
                        class="w-full h-1 bg-white/5 rounded-lg appearance-none cursor-pointer accent-cyan-500 border border-white/5">
                </section>

                <section
                    class="p-4 glass-card rounded-lg flex justify-between items-center border-white/5 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-red-500/0 group-hover:bg-red-500/[0.02] transition-colors"></div>
                    <div class="relative z-10 text-left">
                        <h3 class="text-[10px] font-bold uppercase tracking-widest text-slate-200"
                            data-i18n="neural_comfort">NEURAL COMFORT</h3>
                        <p class="text-[8px] text-slate-500 italic mt-1" data-i18n="comfort_priority">Force maximum
                            priority despite grid stress</p>
                    </div>
                    <button id="override-toggle"
                        class="relative z-10 px-6 py-1.5 border border-slate-700 rounded text-[9px] font-black tracking-[0.2em] uppercase hover:border-red-500 hover:text-red-400 transition-all"
                        data-i18n="disabled">Disabled</button>
                </section>
            </div>

            <!-- Right: Thermal Telemetry -->
            <div class="glass-panel rounded-xl p-6 space-y-6">
                <h2
                    class="text-[10px] font-black text-slate-500 uppercase tracking-widest border-b border-white/5 pb-2">
                    data-i18n="thermal_gov_rt">// THERMAL GOVERNANCE REALTIME</h2>

                <!-- COP Monitor -->
                <div class="p-6 bg-green-500/5 border border-green-500/20 rounded relative group overflow-hidden">
                    <div class="absolute top-0 right-0 p-2 text-[8px] font-black text-green-900/30 font-mono"
                        data-i18n="arctic_opt">
                        ARCTIC_OPTIMIZED</div>
                    <p class="text-[10px] text-green-700 font-bold uppercase tracking-tighter mb-2"
                        data-i18n="cop_monitor">REAL-TIME COP</p>
                    <div class="flex items-center gap-4">
                        <span id="cop-val" class="text-5xl font-technical text-green-400">4.2</span>
                        <div class="flex-1 h-2 bg-green-900/20 rounded-full overflow-hidden">
                            <div id="cop-bar"
                                class="h-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)] transition-all duration-500"
                                style="width: 80%"></div>
                        </div>
                    </div>
                </div>

                <!-- Heat Flow Grid -->
                <div class="grid grid-cols-1 gap-4">
                    <div class="p-4 border border-white/5 rounded glass-card flex justify-between items-center">
                        <div class="text-left">
                            <p class="text-[9px] text-slate-500 uppercase font-black" data-i18n="thermal_entropy">
                                Thermal Entropy (Loss)</p>
                            <p class="text-[8px] text-slate-600 font-technical italic" data-i18n="leakage_desc">//
                                Leakage via Building Envelope
                            </p>
                        </div>
                        <span id="leakage-val" class="text-xl font-technical text-red-400/80">0.95 kW</span>
                    </div>

                    <div class="p-4 border border-white/5 rounded glass-card flex justify-between items-center">
                        <div class="text-left">
                            <p class="text-[9px] text-slate-500 uppercase font-black" data-i18n="heat_flow">Heat Pump
                                Flux</p>
                            <p class="text-[8px] text-slate-600 font-technical italic" data-i18n="active_comp">// Active
                                Thermal Compensation
                            </p>
                        </div>
                        <span id="hp-heat-val" class="text-xl font-technical text-cyan-400">2.10 kW</span>
                    </div>

                    <div id="buh-card"
                        class="p-4 border border-red-500/10 rounded glass-card flex justify-between items-center opacity-30 transition-opacity">
                        <div class="text-left text-red-500/50">
                            <p class="text-[9px] uppercase font-black" data-i18n="buh_status">Backup Heater (BUH)</p>
                            <p class="text-[8px] font-technical italic" data-i18n="reserve_coil">// Reserve Coil
                                Activation</p>
                        </div>
                        <span id="buh-val" class="text-xl font-technical" data-i18n="off_status">OFF</span>
                    </div>
                </div>

                <!-- Learning Progress -->
                <div class="pt-4 border-t border-white/5">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest"
                            data-i18n="thermal_inertia">PHYSICAL THERMAL INERTIA</span>
                        <span id="inertia-val" class="text-[9px] font-technical text-purple-400">82%</span>
                    </div>
                    <div class="w-full h-1 bg-white/5 rounded-full">
                        <div id="inertia-bar" class="h-full bg-purple-500/50 transition-all duration-1000"
                            style="width: 82%"></div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-auto pt-8 border-t border-white/5 text-[9px] text-slate-600 flex justify-between uppercase">
            <span id="status-text" class="font-technical tracking-widest" data-i18n="learning_env">Environment: Learning
                Tasmanian seasonal
                cycles...</span>
            <span class="font-technical" data-i18n="space_v_status">SPACE LEARNER V1.5 // POLISHED</span>
        </footer>
    </main>

    <script type="module">
        import { StateManager } from './state-manager.js';
        import { AIOrchestrator } from './ai-orchestrator.js';
        import { TRANSLATIONS } from './i18n.js';

        const auraAI = new AIOrchestrator();
        const outdoorSlider = document.getElementById('outdoor-slider');
        const outdoorVal = document.getElementById('outdoor-val');
        const indoorSlider = document.getElementById('indoor-slider');
        const indoorVal = document.getElementById('indoor-val');
        const overrideToggle = document.getElementById('override-toggle');
        const saveBtn = document.getElementById('save-btn');
        const statusText = document.getElementById('status-text');

        // New UI Elements
        const copVal = document.getElementById('cop-val');
        const copBar = document.getElementById('cop-bar');
        const leakageVal = document.getElementById('leakage-val');
        const hpHeatVal = document.getElementById('hp-heat-val');
        const buhCard = document.getElementById('buh-card');
        const buhVal = document.getElementById('buh-val');
        const inertiaVal = document.getElementById('inertia-val');
        const inertiaBar = document.getElementById('inertia-bar');
        const aiCommandInput = document.getElementById('ai-command-input');
        const aiInsightText = document.getElementById('ai-insight-text');
        const aiStatusPulse = document.getElementById('ai-status-pulse');

        const lang = localStorage.getItem('tasman-lang') || 'zh';
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (TRANSLATIONS[lang][key]) {
                if (el.tagName === 'TITLE') {
                    document.title = TRANSLATIONS[lang][key];
                } else {
                    el.textContent = TRANSLATIONS[lang][key];
                }
            }
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            if (TRANSLATIONS[lang][key]) el.placeholder = TRANSLATIONS[lang][key];
        });

        let state = StateManager.get();
        let pendingSpace = { ...state.space };

        const updateUI = (s) => {
            if (!s) return;
            outdoorSlider.value = s.outdoor_temp;
            if (outdoorVal) outdoorVal.innerHTML = `${s.outdoor_temp.toFixed(1)}<small class="text-sm">째C</small>`;
            indoorSlider.value = s.indoor_target;
            if (indoorVal) indoorVal.innerHTML = `${s.indoor_target.toFixed(1)}<small class="text-sm">째C</small>`;

            if (overrideToggle) {
                overrideToggle.textContent = s.override ? TRANSLATIONS[lang].status_active : TRANSLATIONS[lang].disabled;
                overrideToggle.className = `relative z-10 px-6 py-1.5 border rounded text-[9px] font-black tracking-[0.2em] uppercase transition-all ${s.override ? 'border-red-500 text-red-500 shadow-[0_0_15px_rgba(239,68,68,0.2)]' : 'border-slate-700 text-slate-400 hover:border-red-500 hover:text-red-400'}`;
            }

            // Thermal Simulation Mirror
            const currentCOP = Math.max(1.8, 5.0 - (Math.abs(s.outdoor_temp - s.indoor_target) * 0.12));
            const leakage = (Math.abs(s.outdoor_temp - s.indoor_target) * state.energy.thermal_coefficient * 0.08).toFixed(2);

            if (copVal) copVal.textContent = currentCOP.toFixed(1);
            if (copBar) copBar.style.width = `${Math.min(100, (currentCOP / 5) * 100)}%`;
            if (leakageVal) leakageVal.textContent = `${leakage} kW`;

            // HP output depends on temperature difference (highly simplified mirror of midea-sim.js)
            const hpWork = (Math.abs(s.outdoor_temp - s.indoor_target) / currentCOP * 3.5).toFixed(2);
            if (hpHeatVal) hpHeatVal.textContent = `${hpWork} kW`;

            const isBuh = Math.abs(s.outdoor_temp - s.indoor_target) > 15;
            if (buhCard && buhVal) {
                buhCard.style.opacity = isBuh ? '1' : '0.3';
                buhVal.textContent = isBuh ? `3.0 kW` : TRANSLATIONS[lang].off_status;
                buhVal.className = `text-xl font-technical ${isBuh ? 'text-red-500 animate-pulse' : ''}`;
            }

            if (inertiaVal && inertiaBar) {
                const progress = (state.energy.fingerprint_val * 100).toFixed(0);
                inertiaVal.textContent = `${progress}%`;
                inertiaBar.style.width = `${progress}%`;
            }
        };

        // Sync with global state
        StateManager.subscribe((newState) => {
            state = newState;
            updateUI(state.space);
        });

        outdoorSlider.addEventListener('input', (e) => {
            pendingSpace.outdoor_temp = parseFloat(e.target.value);
            updateUI(pendingSpace);
            markUnsaved();
        });

        indoorSlider.addEventListener('input', (e) => {
            pendingSpace.indoor_target = parseFloat(e.target.value);
            updateUI(pendingSpace);
            markUnsaved();
        });

        overrideToggle.addEventListener('click', () => {
            pendingSpace.override = !pendingSpace.override;
            updateUI(pendingSpace);
            markUnsaved();
        });

        function markUnsaved() {
            saveBtn.classList.add('animate-pulse', 'border-green-400', 'shadow-[0_0_20px_rgba(34,197,94,0.3)]');
            statusText.textContent = TRANSLATIONS[lang].tuning_mode;
        }

        saveBtn.addEventListener('click', () => {
            StateManager.set('space', pendingSpace);
            saveBtn.classList.remove('animate-pulse', 'border-green-400', 'shadow-[0_0_20px_rgba(34,197,94,0.3)]');
            saveBtn.textContent = TRANSLATIONS[lang].changes_saved;
            statusText.textContent = TRANSLATIONS[lang].thermal_committed;
            setTimeout(() => {
                saveBtn.textContent = TRANSLATIONS[lang].save_btn;
            }, 2000);
        });

        // AI Command Processing
        aiCommandInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && aiCommandInput.value.trim()) {
                const cmd = aiCommandInput.value.trim();
                aiCommandInput.value = '';
                aiStatusPulse.style.opacity = '1';

                try {
                    const forecast = TRANSLATIONS[lang].climate_data_active;
                    const result = await auraAI.processCommand(cmd, state.space, {}, forecast, lang);

                    if (result.feedback) {
                        aiInsightText.textContent = result.feedback;
                        aiInsightText.className = "text-[10px] leading-relaxed text-purple-300 italic font-medium mb-4 animate-in fade-in slide-in-from-bottom-1";
                    }

                    if (result.delta && result.delta.space) {
                        pendingSpace = { ...pendingSpace, ...result.delta.space };
                        StateManager.set('space', pendingSpace);
                        updateUI(pendingSpace);
                    }
                } catch (err) {
                    aiInsightText.textContent = TRANSLATIONS[lang].neural_drift;
                } finally {
                    aiStatusPulse.style.opacity = '0';
                }
            }
        });

        // Initialize UI
        updateUI(state.space);
    </script>
</body>

</html>